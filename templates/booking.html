{% extends "base.html" %}

{% block title %}Book Appointment - MINORE BARBER{% endblock %}

{% block content %}
<div class="booking-form">
    <h2>Book Your Appointment</h2>
    
    {% if error %}
    <div class="error-message">{{ error }}</div>
    {% endif %}
    
    <form method="POST" action="{% if location_id == 1 %}/mallorca/book{% else %}/concell/book{% endif %}" id="bookingForm">
        <div class="form-group">
            <label for="client_name">Your Name</label>
            <input type="text" id="client_name" name="client_name" required>
        </div>
        
        <div class="form-group">
            <label for="client_email">Your Email (optional - for confirmation & cancellation)</label>
            <input type="email" id="client_email" name="client_email" placeholder="Leave empty if you don't want email notifications">
        </div>
        
        <div class="form-group">
            <label for="client_phone">Your Phone</label>
            <input type="tel" id="client_phone" name="client_phone" required>
        </div>
        

        
        <div class="form-group">
            <label for="service_id">Service</label>
            <select id="service_id" name="service_id" required>
                <option value="">Select a service</option>
                {% for service in services %}
                <option value="{{ service.id }}" data-price="{{ service.price }}" data-duration="{{ service.duration }}">
                    {{ service.name }} - â‚¬{{ service.price }} ({{ service.duration }}min)
                </option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label>Choose Your Barber</label>
            <div class="barber-grid">
                <div class="barber-option" data-barber-id="random">
                    <div class="barber-photo random-barber">
                        <span>ðŸŽ²</span>
                    </div>
                    <div class="barber-name">Random</div>
                </div>
                {% for barber in barbers %}
                <div class="barber-option" data-barber-id="{{ barber.id }}">
                    <div class="barber-photo">
                        <img src="/static/photos/{{ location.lower() }}/{{ barber.name }}.jpg" 
                             alt="{{ barber.name }}" 
                             onerror="this.src='/static/photos/{{ location.lower() }}/{{ barber.name }}.PNG'; this.onerror=function(){this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iNTAiIGN5PSI1MCIgcj0iNTAiIGZpbGw9IiNmYmNjOTMiLz48dGV4dCB4PSI1MCIgeT0iNTUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSI0MCIgZmlsbD0iIzFkMWExYyI+8J+RqDwvdGV4dD48L3N2Zz4='}">
                    </div>
                    <div class="barber-name">{{ barber.name }}</div>
                </div>
                {% endfor %}
            </div>
            <input type="hidden" id="barber_id" name="barber_id" required>
        </div>
        
        <div class="form-group">
            <label for="appointment_time">Available Times</label>
            <select id="appointment_time" name="appointment_time" required disabled>
                <option value="">Select barber first</option>
            </select>
        </div>
        
        <button type="submit" class="btn btn-primary">Book Appointment</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateAvailableTimes() {
    // Check if current time is before 11 AM
    const now = new Date();
    const currentHour = now.getHours();
    
    if (currentHour < 11) {
        alert('Appointments are available starting 11 AM');
        document.getElementById('appointment_time').innerHTML = '<option value="">Appointments available from 11 AM</option>';
        document.getElementById('appointment_time').disabled = true;
        return;
    }
    
    const barberId = document.getElementById('barber_id').value;
    const serviceId = document.getElementById('service_id').value;
    const timeSelect = document.getElementById('appointment_time');
    
    if (barberId && serviceId) {
        timeSelect.innerHTML = '<option value="">Loading times...</option>';
        timeSelect.disabled = true;
        
        if (barberId === 'random') {
            // For random selection, get times from first active barber as reference
            const firstBarberId = document.querySelector('#barber_id option[value]:not([value=""]):not([value="random"])').value;
            fetch(`/api/available-times/${firstBarberId}/${serviceId}?t=${Date.now()}`)
                .then(response => response.json())
                .then(times => {
                    timeSelect.innerHTML = '<option value="">Select a time</option>';
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    
                    times.forEach(time => {
                        const [hour, minute] = time.split(':').map(Number);
                        const timeInMinutes = hour * 60 + minute;
                        const currentTimeInMinutes = currentHour * 60 + currentMinute;
                        
                        // Only show times that are in the future
                        if (timeInMinutes > currentTimeInMinutes) {
                            const today = new Date().toISOString().split('T')[0];
                            const datetime = `${today}T${time}:00`;
                            timeSelect.innerHTML += `<option value="${datetime}">${time}</option>`;
                        }
                    });
                    timeSelect.disabled = false;
                })
                .catch(error => {
                    timeSelect.innerHTML = '<option value="">Error loading times</option>';
                    timeSelect.disabled = false;
                });
        } else {
            fetch(`/api/available-times/${barberId}/${serviceId}?t=${Date.now()}`)
                .then(response => response.json())
                .then(times => {
                    timeSelect.innerHTML = '<option value="">Select a time</option>';
                    const now = new Date();
                    const currentHour = now.getHours();
                    const currentMinute = now.getMinutes();
                    
                    times.forEach(time => {
                        const [hour, minute] = time.split(':').map(Number);
                        const timeInMinutes = hour * 60 + minute;
                        const currentTimeInMinutes = currentHour * 60 + currentMinute;
                        
                        // Only show times that are in the future
                        if (timeInMinutes > currentTimeInMinutes) {
                            const today = new Date().toISOString().split('T')[0];
                            const datetime = `${today}T${time}:00`;
                            timeSelect.innerHTML += `<option value="${datetime}">${time}</option>`;
                        }
                    });
                    timeSelect.disabled = false;
                })
                .catch(error => {
                    timeSelect.innerHTML = '<option value="">Error loading times</option>';
                    timeSelect.disabled = false;
                });
        }
    } else {
        timeSelect.innerHTML = '<option value="">Select service and barber first</option>';
        timeSelect.disabled = true;
    }
}

// Barber photo grid selection
document.querySelectorAll('.barber-option').forEach(option => {
    option.addEventListener('click', function() {
        // Remove selected class from all options
        document.querySelectorAll('.barber-option').forEach(opt => opt.classList.remove('selected'));
        
        // Add selected class to clicked option
        this.classList.add('selected');
        
        // Set hidden input value
        const barberId = this.getAttribute('data-barber-id');
        document.getElementById('barber_id').value = barberId;
        
        // Update available times
        updateAvailableTimes();
    });
});

document.getElementById('service_id').addEventListener('change', updateAvailableTimes);
</script>
{% endblock %}